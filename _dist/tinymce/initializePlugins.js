let e$1 = class e{static getDisableFilePoster(e){return e.getParam("oembed_disable_file_poster",false)}static getDisableFileSource(e){return e.getParam("oembed_disable_file_source",false)}static getMediaHeight(e){return e.getParam("oembed_default_height",288)}static getMediaWidth(e){return e.getParam("oembed_default_width",512)}static getUrlResolver(e){return e.getParam("oembed_url_resolver")}static hasDimensions(e){return e.getParam("oembed_dimensions",true)}static hasLiveEmbeds(e){return e.getParam("oembed_live_embeds",true)}static hasPoster(e){return e.getParam("oembed_poster",true)}static shouldFilterHtml(e){return e.getParam("oembed_filter_html",true)}};const t$1=(t,a)=>{if(false===e$1.shouldFilterHtml(t))return a;const r=tinymce.html.Writer();let s;return tinymce.html.SaxParser({validate:false,allow_conditional_comments:false,comment:e=>{s||r.comment(e);},cdata:e=>{s||r.cdata(e);},text:(e,t)=>{s||r.text(e,t);},start:(e,a,o)=>{if(s=true,"script"!==e&&"noscript"!==e&&"svg"!==e){for(let r=a.length-1;r>=0;r--){const s=a[r].name;0===s.indexOf("on")&&(delete a.map[s],a.splice(r,1)),"style"===s&&(a[r].value=t.dom.serializeStyle(t.dom.parseStyle(a[r].value),e));}r.start(e,a,o),s=false;}},end:e=>{s||r.end(e);}},tinymce.html.Schema({})).parse(a),r.getContent()};let a$1;let r$1 = class r{static placeHolderConverter(t){return a=>{let r,n=a.length;for(;n--;)r=a[n],r.parent&&!r.parent.attr("data-mce-object")&&(i$1(r)&&e$1.hasLiveEmbeds(t)?l$1(r)||r.replace(s$1(t,r)):l$1(r)||r.replace(o$1(t,r)));}}static setPoster(e){a$1=e;}};const s$1=(e,t)=>{const r=t.name;void 0!==a$1&&t.attr("data-oembed-poster",a$1);const s=new tinymce.html.Node("span",1);s.attr({contentEditable:"false",style:t.attr("style"),"data-mce-object":r,class:`mce-preview-object mce-object-${r}`}),m$1(e,t,s);const o=e.dom.parseStyle(t.attr("style")),n=new tinymce.html.Node(r,1);if(d$1(t,n,o),n.attr({src:t.attr("src"),style:t.attr("style"),class:t.attr("class")}),"iframe"===r)n.attr({allowfullscreen:t.attr("allowfullscreen"),frameborder:"0"});else {const a=["controls","crossorigin","currentTime","loop","muted","poster","preload"];for(const e of a)n.attr(e,t.attr(e));const o=s.attr("data-mce-html");null!=o&&((e,t,a,r)=>{const s=tinymce.html.DomParser({forced_root_block:false,validate:false},e.schema).parse(r,{context:t});for(;s.firstChild;)a.append(s.firstChild);})(e,r,n,o);}const i=new tinymce.html.Node("span",1);return i.attr("class","mce-shim"),s.append(n),s.append(i),s},o$1=(e,t)=>{const r=t.name;void 0!==a$1&&t.attr("data-oembed-poster",a$1);const s=new tinymce.html.Node("img",1);s.shortEnded=true,m$1(e,t,s);const o=t.attr("data-oembed-poster");return d$1(t,s,{}),s.attr({style:t.attr("style"),src:o||"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","data-mce-object":r,class:`mce-object mce-object-${r}`}),s},n$1=(e,t,a,r=null)=>{const s=e.attr(a);return null!=s?s:Object.hasOwnProperty.call(t,a)?null:r},i$1=e=>{const t=e.name;return "iframe"===t||"video"===t||"audio"===t},c$1=e=>{const t=e.attr("class");return t&&/\btiny-pageembed\b/.test(t)},l$1=e=>{for(;e=e.parent;)if(c$1(e))return true;return false},m$1=(e,a,r)=>{const s=a.attributes;let o=s.length;for(;o--;){const t=s[o].name;let a=s[o].value;"width"!==t&&"height"!==t&&"style"!==t&&("data"!==t&&"src"!==t||(a=e.convertURL(a,t)),r.attr(`data-mce-p-${t}`,a));}const n=a.firstChild&&a.firstChild.value;n&&(r.attr("data-mce-html",escape(t$1(e,n))),r.firstChild=null);},d$1=(e,t,a)=>{const r="img"===t.name||"video"===e.name,s=r?"300":null,o="audio"===e.name?"30":"150",i=r?o:null;t.attr({width:n$1(e,a,"width",s),height:n$1(e,a,"height",i)});},u$1=(e,t)=>{const a=Object.keys(t);for(let r=0,s=a.length;r<s;r++){const s=a[r],o=`${t[s]}`;if(e.map[s]){let t=e.length;for(;t--;){const a=e[t];a.name===s&&(o?(e.map[s]=o,a.value=o):(delete e.map[s],e.splice(t,1)));}}else o&&(e.push({name:s,value:o}),e.map[s]=o);}},h$1=["source"],p$1=(e,t,a)=>{const r=tinymce.html.Writer();let s,o=0;return tinymce.html.SaxParser({validate:false,allow_conditional_comments:true,comment:e=>{r.comment(e);},cdata:e=>{r.cdata(e);},text:(e,t)=>{r.text(e,t);},start:(e,n,i)=>{switch(e){case"video":case"object":case"embed":case"img":case"iframe":void 0!==t.height&&void 0!==t.width&&u$1(n,{width:t.width,height:t.height});}if(a)switch(e){case"video":u$1(n,{poster:t.poster,src:""});break;case"iframe":u$1(n,{src:t.source});break;case"source":if(o<2&&(u$1(n,{src:t[h$1[o]],type:t[`${h$1[o]}mime`]}),!t[h$1[o]]))return;o++;break;case"img":if(!t.poster)return;s=true;}r.start(e,n,i);},end:e=>{if("video"===e&&a)for(let e=0;e<2;e++)if(t[h$1[e]]){const a=[];a.map={},o<=e&&(u$1(a,{src:t[h$1[e]],type:t[`${h$1[e]}mime`]}),r.start("source",a,true));}if(t.poster&&"object"===e&&a&&!s){const e=[];e.map={},u$1(e,{src:t.poster,width:t.width,height:t.height}),r.start("img",e,true);}r.end(e);}},tinymce.html.Schema({})).parse(e),r.getContent()},g$1=(e,t)=>a=>e.selection.selectorChangedWithUnbind(t.join(","),a.setActive).unbind;let b$1 = class b{constructor(e,t){this.tag=e,this.value=t;}static some(e){return new b(true,e)}static none(){return b.singletonNone}fold(e,t){return this.tag?t(this.value):e()}isSome(){return this.tag}isNone(){return !this.tag}map(e){return this.tag?b.some(e(this.value)):b.none()}bind(e){return this.tag?e(this.value):b.none()}exists(e){return this.tag&&e(this.value)}forall(e){return !this.tag||e(this.value)}filter(e){return !this.tag||e(this.value)?this:b.none()}getOr(e){return this.tag?this.value:e}or(e){return this.tag?this:e}getOrThunk(e){return this.tag?this.value:e()}orThunk(e){return this.tag?this:e()}getOrDie(e){if(this.tag)return this.value;throw new Error(null!=e?e:"Called getOrDie on None")}static from(e){return null==e?b.none():b.some(e)}getOrNull(){return this.tag?this.value:null}getOrUndefined(){return this.value}each(e){this.tag&&e(this.value);}toArray(){return this.tag?[this.value]:[]}toString(){return this.tag?`some(${this.value})`:"none()"}};b$1.singletonNone=new b$1(false);const f$1=Object.hasOwnProperty,y$1=(e,t)=>v$1(e,t)?b$1.from(e[t]):b$1.none(),v$1=(e,t)=>f$1.call(e,t),w$1=e=>{let t={};return tinymce.html.SaxParser({validate:false,allow_conditional_comments:true,start:(e,a)=>{t.source||"param"!==e||(t.source=a.map.movie),"iframe"!==e&&"object"!==e&&"embed"!==e&&"video"!==e&&"audio"!==e||(t.type||(t.type=e),t=Object.assign({},a.map,t)),"source"===e&&(t.source||(t.source=a.map.src)),"img"!==e||t.poster||(t.poster=a.map.src),void 0!==a.map["data-oembed-poster"]&&(t.poster=a.map["data-oembed-poster"]);}}).parse(e),t.source=t.source||t.src||t.data,t.poster=t.poster||"",t},A$1=new Map,j$1=[{name:"Vimeo",regex:/^(https:\/\/vimeo.com\/(.*)|https:\/\/vimeo.com\/album\/(.*)\/video\/(.*)|https:\/\/vimeo.com\/channels\/(.*)\/(.*)|https:\/\/vimeo.com\/groups\/(.*)\/videos\/(.*)|https:\/\/vimeo.com\/ondemand\/(.*)\/(.*)|https:\/\/player.vimeo.com\/video\/(.*))/,url:(e,t,a)=>`https://vimeo.com/api/oembed.json?url=${e}&maxwidth=${t}&maxheight=${a}`},{name:"YouTube",regex:/^(https:\/\/(.*).youtube.com\/watch(.*)|https:\/\/(.*).youtube.com\/v\/(.*)|https:\/\/youtu.be\/(.*)|https:\/\/(.*).youtube.com\/playlist?list=(.*))/,url:(e,t,a)=>`https://www.youtube.com/oembed?url=${e}&format=json&maxwidth=${t}&maxheight=${a}`}];let x$1 = class x{static async getEmbedHtml(t,a){let r;if(A$1.has(a.source))return A$1.get(a.source);const s=e$1.getUrlResolver(t);if(s)try{const e=await s({url:a.source});r={url:a.source,html:e.html,poster:e.poster};}catch(e){const a=e.msg||e.message||"Unknown error.";return void t.notificationManager.open({type:"error",text:`Media embed error: ${a}`})}else {let s,o;const n=e$1.getMediaWidth(t),i=e$1.getMediaHeight(t);for(const e of j$1)e.regex.exec(a.source)&&(o=e.url(a.source,n,i),s=e.name);if(void 0===o)return void t.notificationManager.open({type:"error",text:"Media embed error: URL did not match any providers available."});const c=await window.fetch(o);if(!c||200!==c.status)return void t.notificationManager.open({type:"error",text:`Media embed error: Could not fetch ${s} embed URL.`});const l=await c.json();if(void 0===l.html){const e=l.error?l.error:`Could not fetch ${s} embed URL.`;return void t.notificationManager.open({type:"error",text:`Media embed error: ${e}`})}r={url:a.source,html:l.html,poster:l.thumbnail_url};}return A$1.set(a.source,r),r}static isCached(e){return A$1.has(e)}};let _$1 = class _{static showDialog(t){const a=M$1(t);let r=a;const s=F$1(a),o=e$1.getDisableFilePoster(t),n=e$1.getDisableFileSource(t),i=[];i.push({name:"source",type:"urlinput",filetype:n?void 0:"media",label:"Source"}),e$1.hasDimensions(t)&&i.push({type:"sizeinput",name:"dimensions",label:"Constrain proportions",constrain:true}),i.push({name:"poster",type:"urlinput",filetype:o?void 0:"image",label:"Media poster (Image URL)"}),i.push({name:"embed",type:"textarea",label:"Generated Embed:",disabled:true});const c={type:"panel",items:i};t.windowManager.open({title:"Insert/Edit Media (oEmbed)",size:"normal",body:c,buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:true}],onSubmit:async e=>{const a=_.unwrap(e.getData());await U$1(r,a,t),e.close();},onChange:async(e,a)=>{try{switch(a.name){case"source":await $$1(r,e,t);break;case"embed":k$1(e,t);break;case"dimensions":case"poster":N$1(e,a.name);}r=_.unwrap(e.getData());}catch(e){console.log(e);}},initialData:s},void 0);}static unwrap(e,t){const a=t?P$1(t,e).getOr({}):{},r=S$1(e,a,t);return {...r("source"),...r("poster"),...r("embed"),...D$1(e,a)}}};const C$1=["width","height"],O$1=(e,t,a)=>{if("string"==typeof e.url&&e.url.trim().length>0){const r=e.html,s={...H$1(a,r),source:e.url,embed:r,poster:e.poster};t.setData(F$1(s));}},P$1=(e,t)=>y$1(t,e).bind((e=>y$1(e,"meta"))),D$1=(e,t)=>{const a={};return y$1(e,"dimensions").each((e=>{for(const r of C$1)y$1(t,r).orThunk((()=>y$1(e,r))).each((e=>a[r]=e));})),a},M$1=e=>{const t=e.selection.getNode(),a=R$1(t)?e.serializer.serialize(t,{selection:true}):"";return {embed:a,...w$1(a)}},S$1=(e,t,a)=>r=>{const s=()=>y$1(e,r),o=()=>y$1(t,r),n=e=>y$1(e,"value").bind((e=>e.length>0?b$1.some(e):b$1.none()));return {[r]:(r===a?s().bind((e=>"object"==typeof e?n(e).orThunk(o):o().orThunk((()=>b$1.from(e))))):o().orThunk((()=>s().bind((e=>"object"==typeof e?n(e):b$1.from(e)))))).getOr("")}},$$1=async(e,t,a)=>{const r=_$1.unwrap(t.getData(),"source");if(e.source!==r.source){O$1({url:r.source,html:"",poster:""},t,a);const e=await x$1.getEmbedHtml(a,r);e&&O$1(e,t,a);}},k$1=(e,t)=>{const a=_$1.unwrap(e.getData()),r=H$1(t,a.embed);e.setData(F$1(r));},N$1=(e,t)=>{const a=_$1.unwrap(e.getData(),t),r=a.embed?p$1(a.embed,a,false):"";e.setData(F$1({...a,embed:r}));},E$1=(e,t,a)=>{const s=e.dom.select("*[data-mce-object]");r$1.setPoster(a.poster),e.insertContent(t),r$1.setPoster(void 0),T$1(e,s).dataset.oembedPoster=a.poster,e.nodeChanged();},R$1=e=>e.getAttribute("data-mce-object"),T$1=(e,t)=>{const a=e.dom.select("*[data-mce-object]");for(let e=0;e<t.length;e++)for(let r=a.length-1;r>=0;r--)t[e]===a[r]&&a.splice(r,1);return e.selection.select(a[0]),a[0]},H$1=(e,t)=>w$1(t),U$1=async(e,t,a)=>{if(t.embed=p$1(t.embed,t),t.embed&&(e.source===t.source||x$1.isCached(t.source)))E$1(a,t.embed,t);else {const e=await x$1.getEmbedHtml(a,t);e&&E$1(a,e.html,t);}},F$1=e=>{const t={...e,source:{value:y$1(e,"source").getOr("")},poster:{value:y$1(e,"poster").getOr("")}};for(const a of C$1)y$1(e,a).each((e=>{const r=t.dimensions||{};r[a]=e,t.dimensions=r;}));return t};class L{constructor(e){e.addCommand("typhonjsOembed",(()=>_$1.showDialog(e))),class{static register(e){e.ui.registry.addToggleButton("typhonjs-oembed",{tooltip:"Insert/edit media",icon:"embed",onAction:()=>{e.execCommand("typhonjsOembed");},onSetup:g$1(e,["img[data-mce-object]","span[data-mce-object]"])}),e.ui.registry.addMenuItem("typhonjs-oembed",{icon:"embed",text:"Media...",onAction:()=>{e.execCommand("typhonjsOembed");}});}}.register(e),class{static setup(e){e.on("ResolveName",(e=>{let t;1===e.target.nodeType&&(t=e.target.getAttribute("data-mce-object"))&&(e.name=t);}));}}.setup(e),class{static setup(e){e.on("preInit",(()=>{e.parser.addNodeFilter("iframe,video,audio,object,embed",r$1.placeHolderConverter(e)),e.serializer.addAttributeFilter("data-mce-object",((a,r)=>{let s,o,n,i,c,l,m,d,u=a.length;for(;u--;)if(s=a[u],s.parent){for(m=s.attr(r),o=new tinymce.html.Node(m,1),"audio"!==m&&(d=s.attr("class"),d&&-1!==d.indexOf("mce-preview-object")?o.attr({width:s.firstChild.attr("width"),height:s.firstChild.attr("height")}):o.attr({width:s.attr("width"),height:s.attr("height")})),o.attr({style:s.attr("style")}),i=s.attributes,n=i.length;n--;){const e=i[n].name;0===e.indexOf("data-mce-p-")&&o.attr(e.substr(11),i[n].value);}c=s.attr("data-mce-html"),c&&(l=new tinymce.html.Node("#text",3),l.raw=true,l.value=t$1(e,unescape(c)),o.append(l)),s.replace(o);}}));}));}}.setup(e),class{static setup(e){e.on("click keyup touchend",(()=>{const t=e.selection.getNode();t&&e.dom.hasClass(t,"mce-preview-object")&&e.dom.getAttrib(t,"data-mce-selected")&&t.setAttribute("data-mce-selected","2");})),e.on("ObjectSelected",(e=>{"script"===e.target.getAttribute("data-mce-object")&&e.preventDefault();})),e.on("ObjectResized",(e=>{const t=e.target;let a;t.getAttribute("data-mce-object")&&(a=t.getAttribute("data-mce-html"),a&&(a=unescape(a),t.setAttribute("data-mce-html",escape(p$1(a,{width:String(e.width),height:String(e.height)})))));}));}}.setup(e);}getMetadata(){return {name:"TyphonJS oEmbed",url:"https://github.com/typhonjs-tinymce/oembed"}}}const z$1=()=>{tinymce.PluginManager.add("typhonjs-oembed",L);};

class e{static getDisableFilePoster(e){return e.getParam("oembed_disable_file_poster",false)}static getDisableFileSource(e){return e.getParam("oembed_disable_file_source",false)}static getMediaHeight(e){return e.getParam("oembed_default_height",288)}static getMediaWidth(e){return e.getParam("oembed_default_width",512)}static getUrlResolver(e){return e.getParam("oembed_url_resolver")}static hasDimensions(e){return e.getParam("oembed_dimensions",true)}static hasLiveEmbeds(e){return e.getParam("oembed_live_embeds",true)}static hasPoster(e){return e.getParam("oembed_poster",true)}static shouldFilterHtml(e){return e.getParam("oembed_filter_html",true)}}const t=(t,r)=>{if(false===e.shouldFilterHtml(t))return r;const a=tinymce.html.Writer();let s;return tinymce.html.SaxParser({validate:false,allow_conditional_comments:false,comment:e=>{s||a.comment(e);},cdata:e=>{s||a.cdata(e);},text:(e,t)=>{s||a.text(e,t);},start:(e,r,o)=>{if(s=true,"script"!==e&&"noscript"!==e&&"svg"!==e){for(let a=r.length-1;a>=0;a--){const s=r[a].name;0===s.indexOf("on")&&(delete r.map[s],r.splice(a,1)),"style"===s&&(r[a].value=t.dom.serializeStyle(t.dom.parseStyle(r[a].value),e));}a.start(e,r,o),s=false;}},end:e=>{s||a.end(e);}},tinymce.html.Schema({})).parse(r),a.getContent()};let r;class a{static placeHolderConverter(t){return r=>{let a,n=r.length;for(;n--;)a=r[n],a.parent&&!a.parent.attr("data-mce-object")&&(i(a)&&e.hasLiveEmbeds(t)?l(a)||a.replace(s(t,a)):l(a)||a.replace(o(t,a)));}}static setPoster(e){r=e;}}const s=(e,t)=>{const a=t.name;void 0!==r&&t.attr("data-oembed-poster",r);const s=new tinymce.html.Node("span",1);s.attr({contentEditable:"false",style:t.attr("style"),"data-mce-object":a,class:`mce-preview-object mce-object-${a}`}),m(e,t,s);const o=e.dom.parseStyle(t.attr("style")),n=new tinymce.html.Node(a,1);if(d(t,n,o),n.attr({src:t.attr("src"),style:t.attr("style"),class:t.attr("class")}),"iframe"===a)n.attr({allowfullscreen:t.attr("allowfullscreen"),frameborder:"0"});else {const r=["controls","crossorigin","currentTime","loop","muted","poster","preload"];for(const e of r)n.attr(e,t.attr(e));const o=s.attr("data-mce-html");null!=o&&((e,t,r,a)=>{const s=tinymce.html.DomParser({forced_root_block:false,validate:false},e.schema).parse(a,{context:t});for(;s.firstChild;)r.append(s.firstChild);})(e,a,n,o);}const i=new tinymce.html.Node("span",1);return i.attr("class","mce-shim"),s.append(n),s.append(i),s},o=(e,t)=>{const a=t.name;void 0!==r&&t.attr("data-oembed-poster",r);const s=new tinymce.html.Node("img",1);s.shortEnded=true,m(e,t,s);const o=t.attr("data-oembed-poster");return d(t,s,{}),s.attr({style:t.attr("style"),src:o||"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","data-mce-object":a,class:`mce-object mce-object-${a}`}),s},n=(e,t,r,a=null)=>{const s=e.attr(r);return null!=s?s:Object.hasOwnProperty.call(t,r)?null:a},i=e=>{const t=e.name;return "iframe"===t||"video"===t||"audio"===t},c=e=>{const t=e.attr("class");return t&&/\btiny-pageembed\b/.test(t)},l=e=>{for(;e=e.parent;)if(c(e))return true;return false},m=(e,r,a)=>{const s=r.attributes;let o=s.length;for(;o--;){const t=s[o].name;let r=s[o].value;"width"!==t&&"height"!==t&&"style"!==t&&("data"!==t&&"src"!==t||(r=e.convertURL(r,t)),a.attr(`data-mce-p-${t}`,r));}const n=r.firstChild&&r.firstChild.value;n&&(a.attr("data-mce-html",escape(t(e,n))),a.firstChild=null);},d=(e,t,r)=>{const a="img"===t.name||"video"===e.name,s=a?"300":null,o="audio"===e.name?"30":"150",i=a?o:null;t.attr({width:n(e,r,"width",s),height:n(e,r,"height",i)});},u=["source"],h=(e,t,r,a)=>{let s=0;const o=tinymce.html.DomParser(a);o.addNodeFilter("source",(e=>e.length));const n=o.parse(e);for(let e=n;e;e=e.walk())if(1===e.type){const a=e.name;switch(a){case"video":case"object":case"embed":case"img":case"iframe":void 0!==t.height&&void 0!==t.width&&(e.attr("width",t.width),e.attr("height",t.height));}if(r)switch(a){case"video":e.attr("poster",t.poster),e.attr("src",null);break;case"iframe":e.attr("src",t.source);break;case"source":if(s<2&&(e.attr("src",t[u[s]]),e.attr("type",t[u[s]+"mime"]||null),!t[u[s]])){e.remove();continue}s++;break;case"img":t.poster||e.remove();}}return tinymce.html.Serializer({},a).serialize(n)},p=(e,t)=>r=>e.selection.selectorChangedWithUnbind(t.join(","),r.setActive).unbind;class b{constructor(e,t){this.tag=e,this.value=t;}static some(e){return new b(true,e)}static none(){return b.singletonNone}fold(e,t){return this.tag?t(this.value):e()}isSome(){return this.tag}isNone(){return !this.tag}map(e){return this.tag?b.some(e(this.value)):b.none()}bind(e){return this.tag?e(this.value):b.none()}exists(e){return this.tag&&e(this.value)}forall(e){return !this.tag||e(this.value)}filter(e){return !this.tag||e(this.value)?this:b.none()}getOr(e){return this.tag?this.value:e}or(e){return this.tag?this:e}getOrThunk(e){return this.tag?this.value:e()}orThunk(e){return this.tag?this:e()}getOrDie(e){if(this.tag)return this.value;throw new Error(null!=e?e:"Called getOrDie on None")}static from(e){return null==e?b.none():b.some(e)}getOrNull(){return this.tag?this.value:null}getOrUndefined(){return this.value}each(e){this.tag&&e(this.value);}toArray(){return this.tag?[this.value]:[]}toString(){return this.tag?`some(${this.value})`:"none()"}}b.singletonNone=new b(false);const g=Object.hasOwnProperty,f=(e,t)=>y(e,t)?b.from(e[t]):b.none(),y=(e,t)=>g.call(e,t),v=(e,t)=>{let r={};for(let a=tinymce.html.DomParser({validate:false,forced_root_block:false},t).parse(e);a;a=a.walk())if(1===a.type){const e=a.name;r.source||"param"!==e||(r.source=a.attributes.map.movie),"iframe"!==e&&"object"!==e&&"embed"!==e&&"video"!==e&&"audio"!==e||(r.type||(r.type=e),r=Object.assign({},a.attributes.map,r)),"source"===e&&(r.source||(r.source=a.attr("src"))),"img"!==e||r.poster||(r.poster=a.attr("src")),void 0!==a.attributes.map["data-oembed-poster"]&&(r.poster=a.attributes.map["data-oembed-poster"]);}return r.source=r.source||r.src||r.data,r.poster=r.poster||"",r},w=new Map,A=[{name:"Vimeo",regex:/^(https:\/\/vimeo.com\/(.*)|https:\/\/vimeo.com\/album\/(.*)\/video\/(.*)|https:\/\/vimeo.com\/channels\/(.*)\/(.*)|https:\/\/vimeo.com\/groups\/(.*)\/videos\/(.*)|https:\/\/vimeo.com\/ondemand\/(.*)\/(.*)|https:\/\/player.vimeo.com\/video\/(.*))/,url:(e,t,r)=>`https://vimeo.com/api/oembed.json?url=${e}&maxwidth=${t}&maxheight=${r}`},{name:"YouTube",regex:/^(https:\/\/(.*).youtube.com\/watch(.*)|https:\/\/(.*).youtube.com\/v\/(.*)|https:\/\/youtu.be\/(.*)|https:\/\/(.*).youtube.com\/playlist?list=(.*))/,url:(e,t,r)=>`https://www.youtube.com/oembed?url=${e}&format=json&maxwidth=${t}&maxheight=${r}`}];class j{static async getEmbedHtml(t,r){let a;if(w.has(r.source))return w.get(r.source);const s=e.getUrlResolver(t);if(s)try{const e=await s({url:r.source});a={url:r.source,html:e.html,poster:e.poster};}catch(e){const r=e.msg||e.message||"Unknown error.";return void t.notificationManager.open({type:"error",text:`Media embed error: ${r}`})}else {let s,o;const n=e.getMediaWidth(t),i=e.getMediaHeight(t);for(const e of A)e.regex.exec(r.source)&&(o=e.url(r.source,n,i),s=e.name);if(void 0===o)return void t.notificationManager.open({type:"error",text:"Media embed error: URL did not match any providers available."});const c=await window.fetch(o);if(!c||200!==c.status)return void t.notificationManager.open({type:"error",text:`Media embed error: Could not fetch ${s} embed URL.`});const l=await c.json();if(void 0===l.html){const e=l.error?l.error:`Could not fetch ${s} embed URL.`;return void t.notificationManager.open({type:"error",text:`Media embed error: ${e}`})}a={url:r.source,html:l.html,poster:l.thumbnail_url};}return w.set(r.source,a),a}static isCached(e){return w.has(e)}}class x{static showDialog(t){const r=P(t);let a=r;const s=U(r),o=e.getDisableFilePoster(t),n=e.getDisableFileSource(t),i=[];i.push({name:"source",type:"urlinput",filetype:n?void 0:"media",label:"Source"}),e.hasDimensions(t)&&i.push({type:"sizeinput",name:"dimensions",label:"Constrain proportions",constrain:true}),i.push({name:"poster",type:"urlinput",filetype:o?void 0:"image",label:"Media poster (Image URL)"}),i.push({name:"embed",type:"textarea",label:"Generated Embed:",enabled:false});const c={type:"panel",items:i};t.windowManager.open({title:"Insert/Edit Media (oEmbed)",size:"normal",body:c,buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:true}],onSubmit:async e=>{const r=x.unwrap(e.getData());await H(a,r,t),e.close();},onChange:async(e,r)=>{try{switch(r.name){case"source":await k(a,e,t);break;case"embed":S(e,t);break;case"dimensions":case"poster":N(e,r.name);}a=x.unwrap(e.getData());}catch(e){console.log(e);}},initialData:s},void 0);}static unwrap(e,t){const r=t?D(t,e).getOr({}):{},a=M(e,r,t);return {...a("source"),...a("poster"),...a("embed"),...O(e,r)}}}const C=["width","height"],_=(e,t,r)=>{if("string"==typeof e.url&&e.url.trim().length>0){const a=e.html,s={...T(r,a),source:e.url,embed:a,poster:e.poster};t.setData(U(s));}},D=(e,t)=>f(t,e).bind((e=>f(e,"meta"))),O=(e,t)=>{const r={};return f(e,"dimensions").each((e=>{for(const a of C)f(t,a).orThunk((()=>f(e,a))).each((e=>r[a]=e));})),r},P=e=>{const t=e.selection.getNode(),r=$(t)?e.serializer.serialize(t,{selection:true}):"";return {embed:r,...v(r)}},M=(e,t,r)=>a=>{const s=()=>f(e,a),o=()=>f(t,a),n=e=>f(e,"value").bind((e=>e.length>0?b.some(e):b.none()));return {[a]:(a===r?s().bind((e=>"object"==typeof e?n(e).orThunk(o):o().orThunk((()=>b.from(e))))):o().orThunk((()=>s().bind((e=>"object"==typeof e?n(e):b.from(e)))))).getOr("")}},k=async(e,t,r)=>{const a=x.unwrap(t.getData(),"source");if(e.source!==a.source){_({url:a.source,html:"",poster:""},t,r);const e=await j.getEmbedHtml(r,a);e&&_(e,t,r);}},S=(e,t)=>{const r=x.unwrap(e.getData()),a=T(t,r.embed);e.setData(U(a));},N=(e,t)=>{const r=x.unwrap(e.getData(),t),a=r.embed?h(r.embed,r,false):"";e.setData(U({...r,embed:a}));},E=(e,t,r)=>{const s=e.dom.select("*[data-mce-object]");a.setPoster(r.poster),e.insertContent(t),a.setPoster(void 0),R(e,s).dataset.oembedPoster=r.poster,e.nodeChanged();},$=e=>e.getAttribute("data-mce-object"),R=(e,t)=>{const r=e.dom.select("*[data-mce-object]");for(let e=0;e<t.length;e++)for(let a=r.length-1;a>=0;a--)t[e]===r[a]&&r.splice(a,1);return e.selection.select(r[0]),r[0]},T=(e,t)=>v(t),H=async(e,t,r)=>{if(t.embed=h(t.embed,t),t.embed&&(e.source===t.source||j.isCached(t.source)))E(r,t.embed,t);else {const e=await j.getEmbedHtml(r,t);e&&E(r,e.html,t);}},U=e=>{const t={...e,source:{value:f(e,"source").getOr("")},poster:{value:f(e,"poster").getOr("")}};for(const r of C)f(e,r).each((e=>{const a=t.dimensions||{};a[r]=e,t.dimensions=a;}));return t};class z{constructor(e){e.addCommand("typhonjsOembed",(()=>x.showDialog(e))),class{static register(e){e.ui.registry.addToggleButton("typhonjs-oembed",{tooltip:"Insert/edit media",icon:"embed",onAction:()=>{e.execCommand("typhonjsOembed");},onSetup:p(e,["img[data-mce-object]","span[data-mce-object]"])}),e.ui.registry.addMenuItem("typhonjs-oembed",{icon:"embed",text:"Media...",onAction:()=>{e.execCommand("typhonjsOembed");}});}}.register(e),class{static setup(e){e.on("ResolveName",(e=>{let t;1===e.target.nodeType&&(t=e.target.getAttribute("data-mce-object"))&&(e.name=t);}));}}.setup(e),class{static setup(e){e.on("preInit",(()=>{e.parser.addNodeFilter("iframe,video,audio,object,embed",a.placeHolderConverter(e)),e.serializer.addAttributeFilter("data-mce-object",((r,a)=>{let s,o,n,i,c,l,m,d,u=r.length;for(;u--;)if(s=r[u],s.parent){for(m=s.attr(a),o=new tinymce.html.Node(m,1),"audio"!==m&&(d=s.attr("class"),d&&-1!==d.indexOf("mce-preview-object")?o.attr({width:s.firstChild.attr("width"),height:s.firstChild.attr("height")}):o.attr({width:s.attr("width"),height:s.attr("height")})),o.attr({style:s.attr("style")}),i=s.attributes,n=i.length;n--;){const e=i[n].name;0===e.indexOf("data-mce-p-")&&o.attr(e.substr(11),i[n].value);}c=s.attr("data-mce-html"),c&&(l=new tinymce.html.Node("#text",3),l.raw=true,l.value=t(e,unescape(c)),o.append(l)),s.replace(o);}}));}));}}.setup(e),class{static setup(e){e.on("click keyup touchend",(()=>{const t=e.selection.getNode();t&&e.dom.hasClass(t,"mce-preview-object")&&e.dom.getAttrib(t,"data-mce-selected")&&t.setAttribute("data-mce-selected","2");})),e.on("ObjectSelected",(e=>{"script"===e.target.getAttribute("data-mce-object")&&e.preventDefault();})),e.on("ObjectResized",(e=>{const t=e.target;let r;t.getAttribute("data-mce-object")&&(r=t.getAttribute("data-mce-html"),r&&(r=unescape(r),t.setAttribute("data-mce-html",escape(h(r,{width:String(e.width),height:String(e.height)})))));}));}}.setup(e);}getMetadata(){return {name:"TyphonJS oEmbed",url:"https://github.com/typhonjs-tinymce/oembed"}}}const F=()=>{tinymce.PluginManager.add("typhonjs-oembed",(e=>new z(e)));};

let MCE_OEMBED_PLUGIN_INITIALIZED = false;

if (!MCE_OEMBED_PLUGIN_INITIALIZED)
{
   MCE_OEMBED_PLUGIN_INITIALIZED = true;

   /**
    * Handle loading the TyphonJS oEmbed TinyMCE plugin based on Foundry version.
    *
    * v9 of Foundry ships with TinyMCE v5.
    * v10 of Foundry ships with TinyMCE v6.
    */
   Hooks.once('init', async () =>
   {
      const isV10 = !foundry.utils.isNewerVersion(10, game.version ?? game?.data?.version);

      try
      {
         if (isV10)
         {
            // Load oEmbed TinyMCE v6 plugin.
            F();
         }
         else
         {
            // Load oEmbed TinyMCE v5 plugin.
            z$1();
         }
      }
      catch (err)
      {
         console.warn(`TyphonJS Runtime Library warning: Failed to load TyphonJS oEmbed plugin.`);
      }
   });
}
//# sourceMappingURL=initializePlugins.js.map
